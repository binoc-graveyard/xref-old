<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
 <head>
 <title>Check JS coloration</title>
 <style>
    .url
    {
        font-family: monospace;
    }
    .diff
    {
        white-space: pre-wrap;
        border: 1px solid black;
    }
    .err
    {
        background: #f88;
    }
    .ok
    {
        background: #8f8;
    }
    iframe
    {
        width: 30em;
        height: 50em;
        display: none;
    }
    .outer
    {
        border: 1px solid black;
        padding: .5em;
        margin: .5em;
    }
 </style>
 <script src="../jquery-1.3.2.min.js"></script>
 <script src="check_jscoloration.js"></script>
 <script>
  function checkJSColoration (url, elt) {
    if (url.indexOf ("?") == -1) {
      url += "?";
    } else {
      url += "&";
    }
    url += "randomDummy=" + (new Date().getTime()) + "&jscoloration=";

    function addIframe(url, descr, onload) {
      var ifr = document.createElement ("iframe");
      $(elt).append (ifr).
        append ("<a href='" + url + "'>" + descr + "</a> ");
      $.get (
        url,
        null,
        function (data) {
          var doc = ifr.contentWindow.document;
          ifr.onload = onload;
          doc.open();
          ifr.htmlSourceCode = data;
          doc.write (data + "<script>document.close();<" + "/script>");
        },
        "text"
      );
      return ifr;
    };
    var ifr, ifr2;
    ifr = addIframe (
      url + 0,
      "Classic",
      function() {
        ifr2 = addIframe (
          url + 1,
          "JS coloration",
          function() {
            var codeWithout, codeWith;
            codeWithout = ifr.htmlSourceCode.match (/<span id='the-code'>([\s\S]+?)<\/span><\/pre>/)[1];
            var win = ifr2.contentWindow;
            codeWith = win.theCode2.join ("");
            var sizeWith = ifr2.htmlSourceCode.length, sizeWithout = ifr.htmlSourceCode.length;
            var div = document.createElement ("div");
            $(elt).append(" (Saving roughly <strong>" + (100 - Math.round (100 * sizeWith / sizeWithout)) + "%</strong>)" );
            if (codeWith == codeWithout) {
              $(elt).append("<div class='ok'>Way to go !</div>");
            } else {
              function findDiff (s1, s2) {
                s1 = s1.split ("\n");
                s2 = s2.split ("\n");
                for (var i=0; i < s1.length; i++) {
                  if (s1[i] != s2[i]) {
                    return { o: s1[i], n: s2[i], i: i };
                  }
                }
              };
              function htmlspc (s) {
                return s.replace (/&/g, "&amp;").
                  replace (/</g, "&lt;");
              };
              var diff = findDiff (codeWithout, codeWith);
              if (diff) {
                $(elt).append ("<div class='err'>No way !<br />Difference found at line: " + (diff.i + 1) + "</div>").
                  append ("<pre class='diff'>" + htmlspc (diff.o) + "\n" + htmlspc (diff.n) + "</pre>");
              }
            }
          }
        );
      }
    );
  };

  function addJSColorationChecker (url) {
    var root = "../zetests/source/jscoloration/";
    var div = $("<div></div>").get (0);
    var bt = $("<input type='button' value='Check JS coloration' />").
      click (
        function() {
          $(div).empty ();
          checkJSColoration (root + url, div);
        }
      );
    $("<div class='outer'></div>").
      append ($("<span class='url'></span>").text (url), " ", bt, div).
      appendTo ("body");
  };
  window.onload = function() {
    filesToCheck.push ("linecounting.js?mark=6,11-12,15-20,25-27,30-50,29-30,30-50,30-51,55-,35");
    for (var i=0; i < filesToCheck.length; i++) {
      addJSColorationChecker (filesToCheck[i]);
    }
  };
 </script>
 </head>
 <body>
    Checks that the code formated using JS coloration is the same as the one generated by the perl script.
 </body>
</html>
